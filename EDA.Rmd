---
title: "Customer Revenue Prediction EDA"
output: html_notebook
---

This is a simple Exploratory Data Analysis in order to get a little grip of the variables in dataset.

# Table of Contents {#Contents}

 * [Prerequisites](#Prerequisites)
 
 * [1. Understanding the data](#Understanding)
 
 * [2. Look for NA's](#NAs)
 
 * [3. Plot some data](#Plotting)

# Prerequisites {#Prerequisites}

The first thing we need is get what variables are going to be necessary, for this the first step is to get the variables in the json columns and transform them into separate variables. This might help you:

[Json Extraction](https://www.kaggle.com/mrlong/r-flatten-json-columns-to-make-single-data-frame)

The second step is to get rid of all the constant variables in both train and test datasets.

[Table of Contents](#Contents)

## 1. Understanding the data {#Understanding}

**fullVisitorId**- A unique identifier for each user of the Google Merchandise Store.

**channelGrouping** - The channel via which the user came to the Store.

**date** - The date on which the user visited the Store.

**device** - The specifications for the device used to access the Store.

  * **browser**: The browser used to access the Store.

  * **operatingSystem**: Operating system of the device.
  
  * **isMobile**: Whether the access was from a mobile or tablet.
  
  * **deviceCategory**: specifies if the device is a Table, a Mobile or a Desktop.
 

**geoNetwork** - This section contains information about the geography of the user.

  * **continent**: Self explanatory

  * **subContinent**: A more specific continent information.
  
  * **country**: Self explanatory
  
  * **region**: Self explanatory
  
  * **metro**: mostly north american cities, includes state.

  * **networkDomain**: Network provider.

**sessionId** - A unique identifier for this visit to the store.

**socialEngagementType** - Engagement type, either "Socially Engaged" or "Not Socially Engaged".

**totals** - This section contains aggregate values across the session.

  * **hits**: Each loaded item.
  
  * **pageviews**: The number of times a page was viewed.
  
  * **bounces**: Visits that consist of one page-view.

  * **newVisits**: New visits to the domain
  
  * **transactionRevenue**: The target to predict, only in train dataset.

**trafficSource** - This section contains information about the Traffic Source from which the session originated.

  * **campaign**: 
  
  * **source**: The previous source that directed to the Store.
  
  * **medium**: Describes how the user got there, because a referral, by their own (organic), ...

  * **keyword**: Keywords used in a search, for example:  "you tube tshirt", "youtuber water bottle", "www dot google dot com" 
  
  * **adwordsClickInfo**: Extra information provided by AdWords
  
  * **isTrueDirect**: If the visitor came directly to the store
  
    + page
    
    + slot: position of the add, on Top or Right-Hand Side
    
    + gclId: Google Click Identifier appended in the URL used when auto-taggin is enabled .
    
    + adNetworkType: Origin of the search, can be Google Search or Search partners

**visitId** - An identifier for this session. This is part of the value usually stored as the _utmb cookie. This is only unique to the user. For a completely unique ID, you should use a combination of fullVisitorId and visitId.

**visitNumber** - The session number for this user. If this is the first session, then this is set to 1.

**visitStartTime** - The timestamp (expressed as POSIX time).

[Table of Contents](#Contents)

## 2. Look for NA's {#NAs}

Now let's load the dataset:

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
library(data.table)

train <- fread('extraFiles/flattenTrain.csv')
head(train)
```

Let's check for NA's:

```{r}
naCount <- apply(train, 2, function(x) sum(is.na(x)))
naCount <- data.frame(names = names(naCount), count = naCount)
print(naCount)
```

```{r fig.height=15, fig.width=15}
library(ggplot2)
naPlot <- ggplot(naCount, aes(names, weight = count, fill = names)) + 
                geom_bar() + 
                coord_flip() +
                scale_y_continuous(expand = c(0, 0))
naPlot
```

Now lets see the percentage of NAs:

```{r}
naCount$pctNA <- naCount$count*100 / nrow(train)
print(as.data.frame(t(naCount[naCount$pctNA > 0, ])))
```

14 variables out of our current 36 have NAs and 12 of them are over 50%.If we take a closer look, our target "transactionRevenue" has almost 99% of missing values which means that most of the revenue is generated by a small group. Lets explore the zero transaction value visitors against the non-zero ones.

```{r}
ind <- train$transactionRevenue > 0 
ind[is.na(ind)] <- FALSE
nonZeroTrain <- train[ind,]
zeroTrain <- train[which(ind==FALSE),]
```

Lets compare the NAs between these two groups:

```{r}
naZero <- apply(zeroTrain, 2, function(x) sum(is.na(x)))
naZero <- data.frame(names = names(naZero), count = naZero)
print(naZero[naZero$count>0,])
```

```{r}
naNonZero <- apply(nonZeroTrain, 2, function(x) sum(is.na(x)))
naNonZero <- data.frame(names = names(naNonZero), count = naNonZero)
print(naNonZero[naNonZero$count>0,])
```

We have different number of variables in each set, these accounts for the transactionRevenue and page views which only has 100 NA across the board.


```{r fig.height=12, fig.width=12}
naNonZeroPlot <- ggplot(naNonZero[naNonZero$count>0,], aes(names, weight = count, fill = names)) + 
                geom_bar() + 
                coord_flip() +
                xlab('Variables') +
                ylab('NA Count') +
                ggtitle('Non Zero Revenue Visitors') +
                scale_y_continuous(expand = c(0, 0))
naZeroPlot <- ggplot(naZero[naZero$count>0,], aes(names, weight = count, fill = names)) + 
                geom_bar() + 
                coord_flip() +
                xlab('Variables') +
                ylab('NA Count') +
                ggtitle('Zero Revenue Visitors') +
                scale_y_continuous(expand = c(0, 0))

gridExtra::grid.arrange(naNonZeroPlot, naZeroPlot, nrow = 2)
```


Most NAs stay consistent between both groups with the exception of bounces which has less NA in the Zero side and isTrueDirect which decreases on the NonZero groups, that might imply that most revenue visitors already knew about the store. Also, the newVisits NAs increase on the the nonZero visitors which means that the visitor has already been in the store.

So it's more likely that a visitor that has already checked the store and comes directly to it will produce more revenue than first visitors (Duh!)

[Table of Contents](#Contents)

## 3. Plot some data {#Plot}

Now lets check some no NA variables:

```{r echo=FALSE}
noNaVariablesNonZero <- naNonZero[naNonZero$count == 0, ]$names
noNaVariablesZero <- naZero[naZero$count == 0, ]$names

cat('\n\nThe no NAs variables for the NonZero revenue Group are: \n\n')
print(as.character(noNaVariablesNonZero))
cat('\n\nThe no NAs variables for the Zero revenue Group are: \n\n')
print(as.character(noNaVariablesZero))
```

```{r echo=FALSE, fig.height=30, fig.width=15}
channelZero <- ggplot(zeroTrain, aes(x = channelGrouping, fill = channelGrouping)) +
                geom_bar() +
                coord_flip()+
                ggtitle('channelGrouping for Zero Revenue Visitors')
channelNonZero <- ggplot(nonZeroTrain, aes(x = channelGrouping, fill = channelGrouping)) +
                geom_bar() +
                coord_flip() +
                ggtitle('channelGrouping for Non-Zero Revenue Visitors')
browserlZero <- ggplot(zeroTrain, aes(x = browser, fill = browser)) +
                geom_bar() +
                coord_flip()+
                ggtitle('browser for Zero Revenue Visitors')
browserlNonZero <- ggplot(nonZeroTrain, aes(x = browser, fill = browser)) +
                geom_bar() +
                coord_flip() +
                ggtitle('browser for Non-Zero Revenue Visitors')
operatingSystemZero <- ggplot(zeroTrain, aes(x = operatingSystem, fill = operatingSystem)) +
                geom_bar() +
                coord_flip()+
                ggtitle('operatingSystem for Zero Revenue Visitors')
operatingSystemNonZero <- ggplot(nonZeroTrain, aes(x = operatingSystem, fill = operatingSystem)) +
                geom_bar() +
                coord_flip() +
                ggtitle('operatingSystem for Non-Zero Revenue isMobile')
isMobileZero <- ggplot(zeroTrain, aes(x = isMobile, fill = channelGrouping)) +
                geom_bar() +
                coord_flip()+
                ggtitle('isMobile for Zero Revenue Visitors')
isMobileNonZero <- ggplot(nonZeroTrain, aes(x = isMobile, fill = isMobile)) +
                geom_bar() +
                coord_flip() +
                ggtitle('isMobile for Non-Zero Revenue Visitors')
deviceCategoryZero <- ggplot(zeroTrain, aes(x = deviceCategory, fill = deviceCategory)) +
                geom_bar() +
                coord_flip()+
                ggtitle('deviceCategory for Zero Revenue Visitors')
deviceCategoryNonZero <- ggplot(nonZeroTrain, aes(x = deviceCategory, fill = deviceCategory)) +
                geom_bar() +
                coord_flip() +
                ggtitle('deviceCategory for Non-Zero Revenue Visitors')
subContinentZero <- ggplot(zeroTrain, aes(x = subContinent, fill = subContinent)) +
                geom_bar() +
                coord_flip()+
                ggtitle('subContinent for Zero Revenue Visitors')
subContinentNonZero <- ggplot(nonZeroTrain, aes(x = subContinent, fill = subContinent)) +
                geom_bar() +
                coord_flip() +
                ggtitle('subContinent for Non-Zero Revenue Visitors')
gridExtra::grid.arrange(channelZero, channelNonZero,
                        operatingSystemZero, operatingSystemNonZero,
                        isMobileZero, isMobileNonZero,
                        deviceCategoryZero, deviceCategoryNonZero,
                        subContinentZero, subContinentNonZero,
                        browserlNonZero,
                        nrow = 6)
```

A brief summary of the above:

* Most revenue visitors come from referrals and less by social channels.
* While the most used operating system is Windows, Mac users are more likely to produce revenue.
* Most revenue comes from purchases in desktop devices.
* North Americans are the primary source of revenue... by far.
* Chrome and Safari are the primary browsers used by the Non Zero revenue visitors

[Table of Contents](#Contents)



*More to come...*